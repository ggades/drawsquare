var div,posx,posy,initx=false,inity=false,blocked=false;var DS={init:function(){imageArea=$("#imgArea");$("#btnNewMarkup").bind("click",DS.activeAreaMarking);DS.dragMarkup()},getMouse:function(e){obj=$(this);e=window.event||e;posx=0;posy=0;var t=!e?window.event:e;if(t.pageX){posx=t.pageX+window.pageXOffset;posy=t.pageY+window.pageYOffset}else if(t.clientX){posx=t.clientX+document.body.scrollLeft;posy=t.clientY+document.body.scrollTop}else{return false}this.onmousedown=function(){if(blocked==false){initx=posx;inity=posy;var e=$("div.square").last();var t;if(e.html()!=undefined){t=parseInt(e.attr("index"));t=t+1}else{t=1}div=$(document.createElement("div"));div.addClass("square");div.attr({index:t,top:inity,left:initx}).css({left:initx+"px",top:inity+"px"});imageArea.append(div);DS.dragMarkup()}};this.onmouseup=function(){if(blocked==false){var e=$("#btnNewMarkup");initx=false;inity=false;div.addClass("fixed");div.html("<span class='opt link' title='Insert link'>Link</span><span class='delete' title='Remove this markup'>x</span><span class='resize' title='Hold and drag to resize'></span>");$(".delete").unbind("click");$(".delete").bind("click",DS.removeMarkup);$(".opt.link").bind("click",DS.insertLink);$(".square").resizable();e.unbind("click");e.bind("click",DS.activeAreaMarking);e.removeClass("active").text("New markup");imageArea.onmousemove=null;imageArea.className="";blocked=true;return false}};if(initx){div.css({width:Math.abs(posx-initx)+"px",height:Math.abs(posy-inity)+"px",left:posx-initx<0?posx+"px":initx+"px",top:posy-inity<0?posy+"px":inity+"px"})}},activeAreaMarking:function(){var e=$("#imgArea");$(this).text("Awaiting marking...");$(this).addClass("active");$(this).unbind("click");$(this).bind("click",function(){alert("Please finish the current markup before creating another");return false});$("#imgArea").mousemove(DS.getMouse);e.addClass("active");blocked=false;$("#imgArea").animate({margin:"15px auto",opacity:"1"})},removeMarkup:function(){var e=window.confirm("Are you sure you want to delete?");if(e){markup=$(this).parent();$(markup).remove()}},dragMarkup:function(){$(".square").draggable({scroll:false,start:function(){},drag:function(){var e=parseInt($(this).position().top);var t=parseInt($(this).position().left);$(this).css({top:e+"px",left:t+"px"}).attr({top:e,left:t})},stop:function(){},containment:"#imgArea"})},insertLink:function(){var e,t=$(this).parent().attr("link");if(t!=undefined){e=window.prompt("Enter the link",t)}else{e=window.prompt("Enter the link","http://")}if(e!=null){$(this).parent().attr("link",e)}}};$(DS.init)